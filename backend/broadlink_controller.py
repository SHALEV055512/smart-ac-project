from flask import Flask, jsonify
import broadlink
import sys
import codecs

app = Flask(__name__)#הגדרת הסקריפט בתור פלאסק

# כתובת ה-Broadlink
BROADLINK_IP = "10.100.102.2"#כתובת הIP של ברודלינק
sys.stdout = codecs.getwriter("utf-8")(sys.stdout.buffer, errors="replace")#משמש קידוד שונה נותן אפשרות לתמיכה בשפה שונה לדוגמא עברית.

# התחברות ל-Broadlink
try:
    device = broadlink.hello(BROADLINK_IP)#מבצע ניסיון להתחבר לברודלינק
    device.auth()#מבצעת אימות של התחברות
    print("✅ Broadlink connected successfully")
except Exception as e:
    print(f"❌ Failed to connect to Broadlink: {e}")
    device = None

# קודי IR לשליטה במזגן (השארתי מקום למילוי)
ir_code_on = bytes.fromhex("2600b60100011f901512141215351535141315121412151115351513131315351412151214121512151214121512141215121535153515111512151115131313153515111535151214121535141314000280151214131412151214121535141315121435151214361412151214131436143614121511151214131512141215111512141315111512151115351513133615351500050000011f901512141215351535141315111512151115351512141315351412151214121512141314121512141215121535153515111512151115121413153515351436141215111535151214000280151313131512141215111513131315121412151115131313151115121511151314121511151215111513141215111512151214131412151115351535153515351500050000011f9114121512141215111513141215121412151115131412151214121512141314121512141215121413141215121412151214131412151214121512153515121435151215351412150002801412151214131511151214121513131315111512141215131313151115121412151313131511151214121513131315111512141215131412151115351512143515000d05")  # קוד הפעלה
ir_code_off = bytes.fromhex("2600b601000120901511151215351413141215121511151214131412153514361511151215111513131315111512141215131336141313131512141215121413143614121535141215121435151313000280151313131511151215111513131315111413141215131313151115121436143515131313141313131511141413131511141315111513131315111535153515111500050000011f90151214131436141215111413141314131313151115351535151115131313151213131511141413131511153515121412151214131412151213361535143615121413153514121500028014121412151214131413141215111512141314121413151115121413141215121412151214131412141314121512131414121512141214121414143614121535150004ff0001208f15121412151313131511151214121513131315111512141215121413151114131412151214131412151214121413141314121512141215121413143614121535141215351511150002801511151313131511141314131314131315111512141314131412151115121413141215121511151214131412151214121512131414121512141215351511153515000d05 ")  # קוד כיבוי
ir_temp_30 = bytes.fromhex("2600b6010001208f1513141215351535141215121412151215121436143515351512141215131313151115121412151313131535143614121511151214131512143515121535141215121435151314000280141314121512141215121436141314121535151115351512141315111535153515111512151214131412151115121512141314121511151214131436141215121500050000011f90151214131435153515121412151214131511153515351535151115121413141215121511151214131412153515351512141215111513141215351535143614121511153515121400028015121413151214121511151313131512141215111513131315121412151115131313151214121511151314121512141215121413141215121412151214361413140005000001209014121511151314121512141215111513141215121412151115131412151214121512141314121512141215121413141215121412151215121412153515111535151313351513150002801313151115121412151314121511151214121512151215111512141215121512151115121412151215121511151214131412151215111512141315351511153515000d05 ")  # קוד להעלאת טמפרטורה
ir_temp_28 = bytes.fromhex("2600b6010001208f1512141314361436131315121412151115131313153515351412151214131412151214121412151313131535153514121512141215121413143613131535141215121336151313000280151313131511161114121535151214131435151215351412151115131436133614131511151214121512151214121512141314121512141215111513141215121400050000011e911511151313361436141314121511151215121413133615351512141215111513131315121313161015131435153515121412151115131412153515351535131315111535151214000280151114141412151214121511151313131512141215121413131315111512151214131412151115121314141314121511151214131412151214121535151115131300050100011f9014121512151214131412151115121413141314121511151213141412151214121512141314121512141215121413141215121412151115131313153515111436141314351513130002801513131314121512141215131313151115121412151214131412151214121512141313131512141314121413141215111513131314131313151114361513133614000d05")
ir_temp_25 = bytes.fromhex("2600b60100011f901511151214361435151314121511151215351413141215351512141215111512141315121412151115131337133615121412151214121512153515111535151214121535151115000280141314121512151115121435151314121535151115351512141215121535153515111512141215131412151115121412151214131511151214351512143614351500050100011e91141215121435153515121412151215121435151215111535151214131511151214121512151214121512143515351512141315111512141215351535143614131412153515121400028015111512141215121413151115121412151214131412151214121512151214121511151215121512141215111512141315121412151115131335153614361436140005000001208f15121412151214131412151214121512141314121511151215121512141215111512141315121412151115121413151115121412151313131511153515121435151214361413140002801413141215121412151115131412151115121412151314121511151214121512151215111512141314121512141215121413141215121412151115351513133615000d05")
ir_temp_22 = bytes.fromhex("2600b6010001209015121412153514361413151114131412151214351536141215121511151214131412151214121512141314361337131315111512141215121535151214361412151115351511150002801512141314131511151214361412151214361512143515121412151214351535151314121511151214131413141215111512141314121512141215351511153515000500000120901412151115351535151115131313151115121436143515121512141314121511151214131512141215111535153515111513141215111512153514351535151313131535151115000280141215111512151215121412151115131313151214121511151313131511151214121513141215111512141215121512151115121413141215121412153515351400050000011f9114131412151115121413151115121412151313131511141314121512141315111512141215121413141215121412151215121412151115121512153515111535151214351512140002801413141315111512141215121413151115121412151115131511151214121512141314121512141215121413141215111512151215121412151115351513133614000d05")
ir_temp_18 = bytes.fromhex("2600b60100011f90141314121535153515111512141215131412153514121512141215121413141215111512141314131412153514361412151115131412151214351512143614121512153515111500028015111512141215121413153514121511153515121435151314121512143514361512141215121413141215121412151215121412151115131412153515351511150004ff00012090141215121535153515111512141215111513153514121511151214121513141215111512141215121512153514361412151115131313151115351535153515111512143515131400027f15131412151115121512141314121511151214131413141215111512141314121512141215121413151115121412151214131511151214121511151314121535150004ff0001208f151214131511151214121512141315111512141215121413151115121412151215121412151214121512151214121511151215121512141215111535151313361413143614121500027f1512141215121413151115121412151214131511151214121512141314121512141215121512141215111512151215121412151115121413151214351512143614000d05")
ir_temp_16 = bytes.fromhex("2600b6010001208f151214121535153514131511151215111512141315111512141215121413151115121412151115131511153515351511151214121512151215351412153515111512143614131400027f151313131512141215111535151313131535141215351511151214121535153515121512141215111512141315121412151115121413151115121511153515111500050100011e90151215121436143515121511151214131511151214121512141315111512141215111513151115121412153515351412151215121511151214351535153515121413153514121500028014121511151214121513131315111512141215131313151115121412151214131511151214121512141314121512141215121413141215121412153514361413140004ff00012090141315111512141215111513141215121412151115131412151214121511151314121511151215111513141215111512141215131412151115121436141215351413153515111500027f1512151214121511151314121512141215111513131315121412151115131313151115121511151313131511151214121513141215111512141215351512143614000d05")  # קוד להורדת טמפרטורה

@app.route('/turn_on_ac', methods=['GET'])#פונקציה שמאזינה אל הדלקת המזגן ברגע שניתנת הוראה מדליקה את המזגן
def turn_on_ac():
    if device:
        try:
            device.send_data(ir_code_on)
            return jsonify({"status": "success", "message": "✅ AC Turned On!"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ Failed to send IR command: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink device not connected"})

@app.route('/turn_off_ac', methods=['GET'])
def turn_off_ac():
    if device:
        try:
            device.send_data(ir_code_off)
            return jsonify({"status": "success", "message": "✅ AC Turned Off!"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ Failed to send IR command: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink device not connected"})

@app.route('/set_temp_30', methods=['GET'])
def set_temp_30():
    if device:
        try:
            device.send_data(ir_temp_30)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-30°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})


@app.route('/set_temp_28', methods=['GET'])
def set_temp_28():
    if device:
        try:
            device.send_data(ir_temp_28)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-28°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})

@app.route('/set_temp_25', methods=['GET'])
def set_temp_25():
    if device:
        try:
            device.send_data(ir_temp_25)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-25°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})

@app.route('/set_temp_22', methods=['GET'])
def set_temp_22():
    if device:
        try:
            device.send_data(ir_temp_22)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-22°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})

@app.route('/set_temp_18', methods=['GET'])
def set_temp_18():
    if device:
        try:
            device.send_data(ir_temp_18)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-18°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})


@app.route('/set_temp_16', methods=['GET'])
def set_temp_16():
    if device:
        try:
            device.send_data(ir_temp_16)
            return jsonify({"status": "success", "message": "✅ טמפרטורה שונתה ל-16°C"})
        except Exception as e:
            return jsonify({"status": "error", "message": f"❌ שגיאה בשליחת הקוד: {e}"})
    else:
        return jsonify({"status": "error", "message": "❌ Broadlink לא מחובר"})



if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000, debug=True)#הרצת שרת flask אל פורט 8000 ומופעל על כתובת מקומית כל מי שמחובר לרשת ולאו דווקא אל מחשב זה
